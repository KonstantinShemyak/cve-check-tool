/*
 * cli.c - cve-check-tool helpers
 *
 * Copyright (C) 2015 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */

#define _GNU_SOURCE

#include <stdio.h>

#include "config.h"
#include "util.h"
#include "cve-check-tool.h"
#include "cli.h"

void cli_write_report(CveCheckTool *self)
{
        GHashTableIter iter;
        gchar *key = NULL;
        struct source_package_t *v = NULL;
        GList *c = NULL, *t = NULL;
        struct cve_entry_t *entry = NULL;

        g_hash_table_iter_init(&iter, self->db);
        while (g_hash_table_iter_next(&iter, (void**)&key, (void**)&v)) {
                if (!v->issues && !v->patched && !self->show_unaffected) {
                        continue;
                }
                if (!v->issues && self->hide_patched) {
                        continue;
                }
                printf("%s %s (%u patched, %u issues)\n"C_WHITE"------------"C_RESET"\n", key, (char*)v->version, g_list_length(v->patched), g_list_length(v->issues));
                for (c = v->issues; c; c = c->next) {
                        entry = g_hash_table_lookup(self->cdb, (gchar*)c->data);
                        if (self->modified > 0 && entry->modified > self->modified) {
                                continue;
                        }
                        printf(" * "C_RED"%s"C_RESET" : %s\n\n", (char*)c->data, entry->summary);
                        /* Print links.. */
                        bool p = false;
                        for (t = entry->uris; t; t = t->next) {
                                printf("     - %s\n", (char*)t->data);
                                p = true;
                        }
                        if (p) {
                                printf("\n");
                        }
                }
                if (!self->hide_patched) {
                        for (c = v->patched; c; c = c->next) {
                                entry = g_hash_table_lookup(self->cdb, (gchar*)c->data);
                                if (self->modified > 0 && entry->modified > self->modified) {
                                        continue;
                                }
                                printf(" * "C_BLUE"%s [PATCHED]"C_RESET" : %s\n\n", (char*)c->data, entry->summary);
                        }
                }
                printf("\n");
        }
}

