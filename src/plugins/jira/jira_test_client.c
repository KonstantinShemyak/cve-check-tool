/*
 * jira_test_client.h - cve-check-tool
 *
 * Copyright (C) 2015 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */
#include <stdio.h>
#include <time.h>

#include "jira.h"

void show_usage(const gchar *program)
{
    printf(
    "\nSanity tests for the cve-check-tool jira plugin\n\n"
    "Usage: %s -t <test_case> [-c <jira.cfg>] [-V]\n"
    "   -c <path> Path to JIRA cfg file [default=./jira.cfg]\n"
    "   -V         Turn on verbose [default=false]\n"
    "   -t <test_case> Test case to run\n"
    "       1: Check if JIRA server is responsive\n"
    "       2: Do a simple JIRA search and save results to files\n"
    "       3: Add a new JIRA issue and save results to files \n"
    "       4: Add a new JIRA by creating and using a template\n"
    "       5: Same as 2 but less steps using a simplier API\n\n",
    g_path_get_basename(program));
}

/**
 * A simple JIRA plugin client for development purposes only.
 */
int main(int argc, char **argv)
 {
    int opt,test_case = -1;
    bool verbose_flag = false;
    gchar *jira_cfg_path = "jira.cfg";
    gchar *json_path = NULL;
    autofree(gchar) *jira_issues_json = NULL;
    autofree(gchar) *jira_json = NULL;
    autofree(gchar) *summary = NULL;
    autofree(gchar) *description = g_strdup("This is just a test. Ignore");
    GHashTable *jira_issues = NULL;
    GSList *jira_issues_list = NULL;

    time_t now = time(NULL);

    while ((opt = getopt(argc,argv,"c:ht:V")) != -1)
        switch(opt) {
            case 'c':
                jira_cfg_path = argv[optind-1];
                break;
            case 't':
                test_case = atoi(argv[optind-1]);
                break;
            case 'V':
                verbose_flag = true;
                break;
            case 'h':
                show_usage(argv[0]);
                return 0;
        }
    if (test_case < 0) {
        show_usage(argv[0]);
        return -1;
    }
    printf("\n[Execute: test case %i using %s]\n\n", test_case, jira_cfg_path);
    if (!init_jira_plugin(NULL, jira_cfg_path)) return 1;
    set_verbose(verbose_flag);
    switch(test_case) {
        /* Check if JIRA server is responsive */
        case 1:
            if (!is_jira_alive())
                goto cleanup;
            break;
        /* Do a simple query */
        case 2:
            if (!is_jira_alive())
                goto cleanup;
            if (!build_search_jira_issues(&jira_json))
                 goto cleanup;
            if (!search_jira_issues(jira_json, &jira_issues_json))
                goto cleanup;
            if (!parse_jira_issues(jira_issues_json, &jira_issues_list))
                goto cleanup;
            show_jira_issues_list(jira_issues_list);
            if (!save_jira_issues_csv(
                jira_issues_list,"jira_test2_results.csv"))
                goto cleanup;
            if (!save_jira_issues_xml(jira_issues_list,
                "jira_test2_results.xml"))
                goto cleanup;
            if (!save(jira_json, "jira_test2_json.txt"))
                goto cleanup;
            if (!save(jira_issues_json, "jira_test2_issues_json.txt"))
                goto cleanup;
            free_jira_issues_list(&jira_issues_list);
            break;
        /* Add a new JIRA issue */
        case 3:
            if (!is_jira_alive())
                goto cleanup;
            summary =
            g_strdup_printf("CVE-%s (Test:3)", g_strstrip(ctime(&now)));
            if (!build_new_jira_issue(summary, description, false, &jira_json))
                goto cleanup;
            printf("Adding new JIRA issue: [%s]\n", summary);
            if (!add_new_jira_issue(jira_json))
                goto cleanup;
            g_free(jira_json);
            if (!build_search_jira_issues(&jira_json))
                 goto cleanup;
            if (!search_jira_issues(jira_json, &jira_issues_json))
                goto cleanup;
            if (!parse_jira_issues(jira_issues_json, &jira_issues_list))
                goto cleanup;
            show_jira_issues_list(jira_issues_list);
            if (!save_jira_issues_csv(
                jira_issues_list,"jira_test3_results_add.csv"))
                goto cleanup;
            if (!save_jira_issues_xml(
                jira_issues_list,"jira_test3_results_add.xml"))
                goto cleanup;
            free_jira_issues_list(&jira_issues_list);
            break;
        /* Add a new issue using a self-generated template */
        case 4:
            summary =
            g_strdup_printf("CVE-%s (Test:4)", g_strstrip(ctime(&now)));
            if (!build_new_jira_issue(NULL, NULL, true, &jira_json))
                goto cleanup;
            json_path = "jira_test4_results_template_raw.json";
            if (!save(jira_json, json_path))
                goto cleanup;
            g_free(jira_json);
            if (!build_new_jira_issue_file(
                json_path, summary, description, &jira_json))
                goto cleanup;
            json_path = "jira_test4_results_template_resolved.json";
            if (!save(jira_json, json_path))
                goto cleanup;
            if (!add_new_jira_issue(jira_json))
                goto cleanup;
            g_free(jira_json);
            if (!build_search_jira_issues(&jira_json))
                 goto cleanup;
            if (!search_jira_issues(jira_json, &jira_issues_json))
                goto cleanup;
            if (!parse_jira_issues(jira_issues_json, &jira_issues_list))
                goto cleanup;
            show_jira_issues_list(jira_issues_list);
            if (!save_jira_issues_csv(
                jira_issues_list,"jira_test4_results_add.csv"))
                goto cleanup;
            if (!save_jira_issues_xml(
                jira_issues_list,"jira_test4_results_add.xml"))
                goto cleanup;
            free_jira_issues_list(&jira_issues_list);
            break;
        case 5:
            summary =
            g_strdup_printf("CVE-%s (Test:5)", g_strstrip(ctime(&now)));
            if (!build_search_jira_issues(&jira_json)) {
                return false;
            }
            if (!get_jira_issues(jira_json, &jira_issues)) {
                return false;
            }
            show_jira_issues(jira_issues);
            free_jira_issues(&jira_issues);
            break;
        default:
            show_usage(argv[0]);
            printf("Error: Unknown test case: %i\n", test_case);
            break;
    }
    printf("Test passed!\n\n");
    destroy_jira_plugin();
    return 0;
cleanup:
    printf("Test failed!\n\n");
    destroy_jira_plugin();
    return 1;
}
