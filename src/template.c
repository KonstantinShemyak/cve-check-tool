/*
 * template.c - cve-check-tool
 *
 * Copyright (C) 2015 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */

#define _GNU_SOURCE

#include "template.h"
#include "util.h"


#include <string.h>

char *template_string(const char *original, GHashTable *keys)
{
        char *c = NULL, *s = NULL;
        int offset = 0;
        char *ret = NULL;

        if (!keys) {
                /* Always return allocated string for consistency */
                return strdup((char*) original);
        }
        if (!original) {
                return NULL;
        }

        cve_string *input = cve_string_dup(original);
        if (!input) {
                return NULL;
        }

        while ((c = memchr(input->str+offset, '{', input->len-offset))) {
                autofree(cve_string) *newstr = NULL;
                autofree(cve_string) *left = NULL;
                gchar *val = NULL;

                offset = (c - input->str);

                if (*(c+1) != '{') {
                        ++offset;
                        goto bail;
                }
                s = c;
                c = memchr(c, '}', input->len);
                if (!c) {
                        ++offset;
                        goto bail;
                }
                if (*(c+1) != '}') {
                        ++offset;
                        goto bail;
                }
                int start =  (s-input->str);
                start+=2;
                int end =  (c-input->str);
                int length = end - start;

                newstr = cve_string_dup(input->str+start);
                newstr->str[length] = '\0';
                newstr->len = length;

                left = cve_string_dup(input->str);
                left->str[start-2] = '\0';
                left->len = (start-2);
                c += 2;

                cve_string *fullstr = NULL;
                val = g_hash_table_lookup(keys, newstr->str);
                if (val) {
                        /* Ensure null termination and correct length */
                        autofree(cve_string) *dup = cve_string_dup(val);
                        fullstr = cve_string_dup_printf("%s%s%s", left->str, val, c);
                        offset += dup->len;
                } else {
                        fullstr = cve_string_dup_printf("%s %s\n", left->str, c);
                        offset += newstr->len;
                }

                cve_string_free(input);
                input = fullstr;
bail:
                if (offset >= input->len) {
                        break;
                }
                continue;
        }

        ret = input->str;
        free(input);
        return ret;
}
